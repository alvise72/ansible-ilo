---
- name: Query iLO information
  hosts: all
  gather_facts: false
  vars:
    - type: 'hd'
    - url: {
        'gen9': 'https://{{ inventory_hostname }}/redfish/v1/Systems/1/BIOS/Boot/settings',
        'gen10': 'https://{{ inventory_hostname }}/redfish/v1/Systems/1/BootOptions/',
        'gen10p': 'https://{{ inventory_hostname }}/redfish/v1/Systems/1/BootOptions/'
      }
    - gen: 'gen9'

  tasks:
    - name: Gather summary information
      uri:
        url: 'https://{{ inventory_hostname }}/redfish/v1/'
        method: GET
        return_content: yes
        url_username: '{{ username }}'
        url_password: '{{ password }}'
        validate_certs: false
        status_code: 200
        use_proxy: false
        force_basic_auth: true
      register: query
      delegate_to: localhost
      no_log: '{{nolog}}'
      changed_when: false

    - name: Determine if Gen9
      set_fact:
        gen: 'gen9'
      when: query.json.Product is not defined
      changed_when: false
      no_log: '{{ nolog }}'

    - name: Determine if Gen10
      set_fact:
        gen: 'gen10'
      when:
        - query.json.Product is defined
        - query.json.Product is match(".*Gen10")
      changed_when: false
      no_log: '{{ nolog }}'

    - name: Determine if Gen10+
      set_fact:
        gen: 'gen10p'
      when:
        - query.json.Product is defined
        - query.json.Product is match(".*Gen10 Plus")
      changed_when: false
      no_log: '{{ nolog }}'

    - name: Execute URI module to get iLO/BIOS Boot info
      uri:
        url: '{{ url[gen] }}' #'https://{{ inventory_hostname }}/redfish/v1/Systems/1/BIOS/Boot/settings'
        method: GET
        return_content: yes
        url_username: '{{ username }}'
        url_password: '{{ password }}'
        validate_certs: false
        status_code: 200
        use_proxy: false
        force_basic_auth: true
      register: query
      delegate_to: localhost
      no_log: '{{nolog}}'
      changed_when: false

    - name: Showing result (Gen9)
      debug: 
        msg: '{{ query.json.PersistentBootConfigOrder }}'
      when: gen == 'gen9'

    - meta: end_play
      when:  gen == 'gen9' and show is defined

    - name: Init array_boot_devices (Gen10/Gen10+)
      set_fact: 
        array_boot_devices: []
      no_log: '{{ nolog }}'
      when: gen == 'gen10' or gen == 'gen10p'

    - name: Gather boot device IDs (Gen10/Gen10+)
      set_fact:
        array_boot_devices: '{{ array_boot_devices + [ ( item | to_json(ensure_ascii=False) | split(": "))[1][2:-3]]  }}'
      loop: '{{ query.json.Members }}'
      loop_control:
        label: ""
      no_log: '{{ nolog }}'
      when: gen == 'gen10' or gen == 'gen10p'

    - name: Gather boot device names (Gen10/Gen10+)
      uri:
        url: 'https://{{ inventory_hostname }}/{{item}}'
        method: GET
        return_content: yes
        url_username: '{{ username }}'
        url_password: '{{ password }}'
        validate_certs: false
        status_code: 200
        use_proxy: false
        force_basic_auth: true
      register: querybootdev
      delegate_to: localhost
      no_log: '{{nolog}}'
      changed_when: false
      loop: '{{ array_boot_devices }}'
      loop_control:
        label: ""
      when: gen == 'gen10' or gen == 'gen10p'

    - set_fact:
        bootdevs: []
      no_log: '{{nolog}}'
      when: gen == 'gen10' or gen == 'gen10p'

    - name: Collecting all boot devices (Gen10/Gen10+)
      set_fact:
        bootdevs: '{{ bootdevs + [item.json.DisplayName] }}'
      loop: '{{ querybootdev.results }}'
      loop_control:
        label: ""
      no_log: '{{nolog}}'
      when: gen == 'gen10' or gen == 'gen10p'

    - name: Showing Result (Gen10/Gen10+)
      debug:
        msg: '{{ bootdevs }}'
      when: gen == 'gen10' or gen == 'gen10p'

    - meta: end_play
      when: show is defined

    - set_fact:
        otherdevs: []
        nicdevs: []
    
    - set_fact:
        matchboot: 'PXE IPv4'
      when: type == 'net'

    - set_fact:
        matchboot: 'HD.*'
      when: type == 'hd'

    - set_fact:
        nicdevs: '{{ nicdevs + [item] }}'
      loop: "{{ query.json.PersistentBootConfigOrder }}"
      loop_control:
        label: ""
      when: 
        - item is match("{{ matchboot }}")
        - gen == 'gen9'

    - set_fact:
        otherdevs: '{{ otherdevs + [item] }}'
      loop: "{{ query.json.PersistentBootConfigOrder }}"
      loop_control:
        label: ""
      when: 
        - item is not match("{{ matchboot }}")
        - gen == 'gen9'
    
    - set_fact:
        alldevs: '{{ nicdevs + otherdevs }}'
      when: gen == 'gen9'

    - set_fact:
        body: '{ "PersistentBootConfigOrder": {{ alldevs | to_json }} }'
      when: gen == 'gen9'

    - name: Patch BIOS/Boot/settings - PersistentBootConfigOrder
      uri:
        url: 'https://{{ inventory_hostname }}/redfish/v1/systems/1/bios/boot/settings/'
        method: PATCH
        return_content: yes
        url_username: '{{ username }}'
        url_password: '{{ password }}'
        validate_certs: false
        status_code: 200
        use_proxy: false
        force_basic_auth: true
        body_format: json
        body: " {{ body }} "
      register: query
      delegate_to: localhost
      no_log: '{{nolog}}'
      changed_when: false
      when: gen == 'gen9'

...
